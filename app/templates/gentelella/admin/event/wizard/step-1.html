{% set included_items = included_settings %}

{% macro social_entry(social_link=None, name='Twitter') %}
    <div class="social-link-holder">
        <div class=" col-sm-3" style="padding-left: 0;">
            <input type="text" class="form-control" name="social[name]" placeholder="Name"
                   value="{{ social_link.name | default(name, true) }}">
        </div>
        <input type="hidden" name="social[id]" value="{{ social_link.id | default('') }}">
        <div class="col-sm-5 input-group">
            <input data-error="Please enter a valid URL" type="url" class="form-control" name="social[link]"
                   placeholder="Link"
                   value="{{ social_link.link | default('', true) }}">
            <div class="help-block with-errors"></div>
            <span class="input-group-btn">
                <button type="button" class="btn btn-danger remove-social-links">-</button>
                <button type="button" class="btn btn-primary add-social-links">+</button>
            </span>
        </div>
    </div>
{% endmacro %}

<div>
    <div class="col-md-8 col-md-push-2">
        <div class="item row form-group">
            <label>{{_("Name")}} <span class="required">*</span></label>
            <input required="required"
                   data-error="Event name is required"
                   name="name" class="form-control col-md-7 col-xs-12"
                   value="{{ event.name | default('', true) }}"/>

        </div>
        <div class="row form-group">
            <label>{{_("Location")}}</label>
            <input value="{{ event.location_name | default('', true) }}" name="location_name" id="location_name"
                   placeholder="Location is required to make event live"
                   class="form-control col-md-7 col-xs-12"/>
        </div>
        <a id="show_addr" onclick="show_map_holder();" style="cursor:pointer;">{{_("Enter Address")}}</a>

        <div class="row" id="map-holder" style="display:none;">
            <div class="col-md-6">
                <div class="item form-group">
                    <input value="" name="street_number" id="street_number" class="form-control col-md-3 col-xs-12"
                           placeholder="Street Address line 1" onchange="address_update();"/>
                </div>
                <div class="item form-group">
                    <input value="" name="route" id="route" class="form-control col-md-7 col-xs-12"
                           placeholder="Street Address line 2" onchange="address_update();"/>
                </div>
                <div class="item form-group">
                    <input value="" name="locality" id="locality" class="form-control col-md-7 col-xs-12"
                           placeholder="City" onchange="address_update();"/>
                </div>
                <div class="item form-group">
                    <input value="" name="state_area" id="administrative_area_level_1"
                           class="form-control col-md-7 col-xs-12" placeholder="States" onchange="address_update();"/>
                </div>
                <div class="item form-group">
                    <input value="" name="postal_code" id="postal_code" class="form-control col-md-7 col-xs-12"
                           placeholder="Zip Code" onchange="address_update();"/>
                </div>
                <div class="item form-group">
                    <input value="" name="country" id="country" class="form-control col-md-7 col-xs-12"
                           placeholder="Country" onchange="address_update();"/>
                </div>
                <div class="col-md-4">
                    <a id="reset_addr" onclick="remove_map_holder();" style="cursor:pointer;">{{_("Reset Location")}}</a>
                </div>
                <div class="col-md-8">
                    <div class="checkbox" style="padding-top:0;">
                        <label style="padding-left:0;">
                            {% if event %}
                                <input type="checkbox" class="flat" name="show_map" {{ 'checked' if event.show_map == 1 else '' }}>
                            {% else %}
                                <input type="checkbox" class="flat" name="show_map" checked="checked">
                            {% endif %}
                            {{_("Show map on event page")}}
                        </label>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div id="map" class="hidden-xs" style="width:100%; height:300px"></div>
            </div>
            <br>
            <br>
        </div><br><br>

        <div class="row event-date-picker">
            <div class="col-md-4">
                <div class="item form-group">
                    <label>{{_("Starts")}} <span class="required">*</span></label>
                    <br>
                    <div class="col-xs-8" style="padding-left: 0;">
                        <input required="required"
                               name="start_date"
                               data-error="Start date & time is required"
                               value="{{ event.start_time.strftime('%m/%d/%Y') if event else start_date.strftime('%m/%d/%Y') }}"
                               class="form-control col-xs-6 date start" placeholder="MM/DD/YYYY"/>

                    </div>
                    <div class="col-xs-4" style="padding-left: 0;">
                        <input required="required"
                               name="start_time"
                               value="{{ event.start_time.strftime('%H:%M') if event else '19:00' }}"
                               class="form-control col-xs-6 time start" placeholder="HH:MM"/>

                    </div>
                </div>

            </div>
            <div class="col-md-4">
                <div class="item form-group">
                    <label>{{_("Ends")}} <span class="required">*</span></label>
                    <br>
                    <div class="col-xs-8" style="padding-left: 0;">
                        <input required="required"
                               name="end_date"
                               data-error="End date & time is required"
                               value="{{ event.end_time.strftime('%m/%d/%Y') if event else start_date.strftime('%m/%d/%Y') }}"
                               class="form-control col-xs-6 date end" placeholder="MM/DD/YYYY"/>

                    </div>
                    <div class="col-xs-4" style="padding-left: 0;">
                        <input required="required"
                               name="end_time"
                               value="{{ event.end_time.strftime('%H:%M') if event else '22:00' }}"
                               class="form-control col-xs-6 time end" placeholder="HH:MM"/>

                    </div>

                </div>

            </div>
            <div class="col-md-4 col-xs-8">
                <div class="form-group">
                    <label>{{_("Timezone")}} <span class="required">*</span></label>
                    <select name="timezone" class="form-control">
                        {% for value, text in timezones %}
                            {% if event %}
                                <option value="{{ value }}"
                                        {% if event.timezone == value %}selected{% endif %}>{{ text }}</option>
                            {% else %}
                                <option value="{{ value }}"
                                        {% if value == current_timezone %}selected{% endif %}>{{ text }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        <div class="item form-group">
            <label>{{_("Description")}}</label>
            <textarea name="description"
                      class="form-control event-textarea">{{ event.description | default('', true) }}</textarea>
        </div>
        <div class="row">
            <div class="col-md-7">
                <input type="hidden" name="background_url" id="background_url">

                <div class="item form-group" id="image-upload-group"
                     {% if event and event.background_url and event.background_url != '' %}style="display: none;"{% endif %}>
                    <label>{{_("Event Image")}}</label><br>
                    <div class="image-box">
                        <input type="file" id="event-image-upload" name="event-image-upload"
                               class="image-upload-btn no-js"
                               accept="image/*"/>
                        <label class="file-label" for="event-image-upload" id="event-image-upload-label">
                            <i class="fa fa-4x fa-camera-retro" aria-hidden="true"></i> <br>
                            <h3>{{_("Select Event Image")}}</h3>
                        </label><br>
                    </div>
                    <span class="text-muted" style="color: #a2a2a2;">
                        {{_("We recommend using at least a 2160x1080px (2:1 ratio) image")}}<br>{{_("that's no larger than 10MB.")}}
                    </span>
                </div>

                <div class="item form-group" id="image-view-group"
                     {% if not event or not event.background_url or event.background_url == '' %}style="display: none;"{% endif %}>
                    <label>{{_("Event Image")}}</label><br>
                    <img src="{{ event.background_url | default('', true) }}"
                         style="width: 350px; height: 175px;"><br><br>
                    {% if not event %}
                        <button type="button" class="btn btn-sm btn-default" data-target="#cropper-modal"
                                data-toggle="modal">
                            <i class="fa fa-arrows" aria-hidden="true"></i>
                            {{_("Adjust")}}
                        </button>
                    {% endif %}
                    <button type="button" class="btn btn-sm btn-default" id="remove-image-btn">
                        <i class="fa fa-trash-o" aria-hidden="true"></i>
                        {{_("Remove")}}
                    </button>
                    <br>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-7">

                {% if event %}
                    <input type="hidden" id="logo">
                {% else %}
                    <input type="hidden" name="logo" id="logo">
                {% endif %}

                <div class="item form-group" id="logo-upload-group"
                     {% if event and event.logo and event.logo != '' %}style="display: none;"{% endif %}>
                    <label>{{_("Logo")}}</label><br>
                    <div class="image-box">
                        <input type="file" id="logo-upload" name="logo-upload" class="image-upload-btn no-js"
                               accept="image/*"/>
                        <label class="file-label" for="logo-upload" id="logo-upload-label">
                            <i class="fa fa-4x fa-file-image-o" aria-hidden="true"></i> <br>
                            <h3>{{_("Select Logo")}}</h3>
                        </label><br>
                    </div>
                    <span class="text-muted" style="color: #a2a2a2;">
                        {{_("Logo size must be less than 1MB.")}}
                    </span>
                </div>

                <div class="item form-group" id="logo-view-group"
                     {% if not event or not event.logo or event.logo == '' %}style="display: none;"{% endif %}>
                    <label>{{_("Logo")}}</label><br>
                    <img src="{{ event.logo | default('', true) }}" style="width: 350px;"><br><br>
                    <button type="button" class="btn btn-sm btn-default" id="remove-logo-btn">
                        <i class="fa fa-trash-o" aria-hidden="true"></i>
                        {{_("Remove")}}
                    </button>
                    <br>
                </div>
            </div>
        </div>

        <div class="item form-group">
            <label><span class="organizer-state">Add</span> {{_("Organizer Information")}}
            </label>
            <input type="checkbox" class="toggle-switch" name="organizer_state"
                   value="on" id="organizer-switch"
                   {% if event.organizer_name or event.organizer_description %}checked="checked"{% endif %}/>
            <label for="organizer-switch" style="margin-left:0;"></label>
        </div>
        <div id="organizer-holder"
             {% if not event.organizer_name and not event.organizer_description %}style="display:none;"{% endif %}>
            <div class="item form-group">
                <label>{{_("Organizer name")}}</label>
                <input name="organizer_name" class="form-control"
                       value="{{ event.organizer_name | default('', true) }}"/>
            </div>
            <div class="item form-group">
                <label>{{_("Organizer Description")}}
                </label>
                <textarea
                        name="organizer_description"
                        class="form-control event-textarea">{{ event.organizer_description | default('', true) }}</textarea>
            </div>
        </div>
        <div class="item form-group">
            <label>{{_("Links and Social Media")}}</label>
            <div >
                <div class=" col-sm-3" style="padding-left: 0;">
                    <input type="text" class="form-control" placeholder="External Event URL"
                           value="External Event URL" readonly style="background-color: white;">
                </div>
                <div class="col-sm-5 input-group">
                    <input data-error="Please enter a valid URL" type="url" class="form-control" name="event_url"
                           placeholder="Link"
                           value="{{ event.event_url | default('', true) }}">
                    <div class="help-block with-errors"></div>
                    <span class="input-group-btn" style="opacity: 0; pointer-events: none;">
                        <button type="button" class="btn btn-danger remove-social-links">-</button>
                        <button type="button" class="btn btn-primary add-social-links">+</button>
                    </span>
                </div>
            </div>
            <div class="row social-links">
                <div class="col-md-12 col-sm-12 col-xs-12">
                    {% if social_links %}
                        {% for social_link in social_links %}
                            {{ social_entry(social_link) }}
                        {% else %}
                            {{ social_entry(None, 'Twitter') }}
                            {{ social_entry(None, 'Facebook') }}
                        {% endfor %}
                    {% else %}
                        {{ social_entry(None, 'Twitter') }}
                        {{ social_entry(None, 'Facebook') }}
                    {% endif %}
                </div>

            </div>
        </div>
        {% if event.ticket_include or 'ticketing' in included_items %}
            <div class="item form-group">
                <label><span class="ticket-state">{{_("Use Ticketing System")}}</span>
                </label>
                <input type="checkbox" class="toggle-switch" name="ticket_state"
                       value="on" id="ticket-switch" {% if not event.ticket_url or event.identifier in event.ticket_url %}checked="checked"{% endif %}/>

            <label for="ticket-switch" style="margin-left:0;"></label>
        </div>
        <div id="ticket-system-holder" class="item form-group" {% if event.ticket_url and event.identifier not in event.ticket_url %}style="display:none;"{% endif %}>
        <h2 style="font-weight:300; text-transform: uppercase; margin-top: 35px; color:#5bc0de;">
            <i class="fa fa-ticket"></i>
            {{_("Ticket Details")}}
            <hr style="margin:0;border-width: 2px; border-color: #5bc0de;">
        </h2>

        <!-- TicketsSegment -->
        <div class="tickets-segment">
            <div class="row">
                <div class="col-xs-4">
                    <h3 style="font-size: 15px;">{{_("Ticket Name")}} <span class="required">*</span></h3>
                </div>
                <div class="col-xs-3">
                    <h3 style="font-size: 15px;">{{_("Price")}}</h3>
                </div>
                <div class="col-xs-3">
                    <h3 style="font-size: 15px;">{{_("Quantity")}} <span class="required">*</span></h3>
                </div>
                <div class="col-xs-2">
                    <h3 style="font-size: 15px;">{{_("Options")}}</h3>
                </div>
            </div>
            <div class="tickets-holder" style="margin-bottom: 10px;">
            {% if event %}
                {% for ticket in event.tickets %}
                    {{ ticket_template(serialno=loop.index0, name=ticket.name, description=ticket.description, description_toggle=ticket.description_toggle, ticket_tags=ticket.tags,
                    sales_start=ticket.sales_start, sales_end=ticket.sales_end, hide=ticket.hide, price=ticket.price, type=ticket.type,
                    quantity=ticket.quantity, min_order=ticket.min_order, max_order=ticket.max_order, has_orders=ticket.has_order_tickets()) }}
                {% endfor %}
            {% endif %}
            </div>
        </div>

        <div class="row">
            <div class="text-center">
                <a class="btn btn-info add-free-ticket">
                    <i class="glyphicon glyphicon-plus-sign"></i> {{_("Free Ticket")}}
                </a>
                {% if 'payments' in included_items %}
                    <a class="btn btn-info add-paid-ticket">
                        <i class="glyphicon glyphicon-plus-sign"></i> {{_("Paid Ticket")}}
                    </a>
                {% endif %}
                {% if 'donations' in included_items %}
                    <a class="btn btn-info add-donation-ticket">
                        <i class="glyphicon glyphicon-plus-sign"></i> {{_("Donation")}}
                    </a>
                {% endif %}
            </div>
        </div>
        <!-- /TicketsSegment -->

            </div>
            <div id="ticket-url-holder" class="item form-group"
                 {% if not event.ticket_url or event.identifier in event.ticket_url %}style="display:none;"{% endif %}>
                <h2 style="font-weight:300; text-transform: uppercase; margin-top: 35px; color:#5bc0de;">
                    <i class="fa fa-ticket"></i>
                    {{_("Add Ticket URL")}}
                    <hr style="margin:0;border-width: 2px; border-color: #5bc0de;">
                </h2>
                <div class="item form-group">
                    <label>{{_("Ticket URL")}}
                    </label>
                    <input type="url" pattern="https?://.+" name="ticket_url" class="form-control"
                           value="{{ event.ticket_url if event.ticket_url and event.identifier not in event.ticket_url else '' | default('', true) }}" data-error="Please enter a valid URL"/>
                    <div class="help-block with-errors"></div>
                </div>
            </div>
        {% else %}
            <h2 style="font-weight:300; text-transform: uppercase; margin-top: 35px; color:#5bc0de;">
                <i class="fa fa-ticket"></i>
                {{_("Add Ticket URL")}}
                <hr style="margin:0;border-width: 2px; border-color: #5bc0de;">
            </h2>
            <div class="item form-group">
                <label>{{_("Ticket URL")}}
                </label>
                <input type="url" pattern="https?://.+" name="ticket_url" class="form-control"
                       value="{{ event.ticket_url | default('', true) }}" data-error="Please enter a valid URL"/>
                <div class="help-block with-errors"></div>
            </div>
        {% endif %}

        <div id="payment-system-holder" class="item form-group"
             {% if not event or ('paid' not in ticket_types and 'donation' not in ticket_types) %}style="display:none;"{% endif %}>
            <h2 style="font-weight:300; text-transform: uppercase; margin-top: 35px; color:#5bc0de;">
                <i class="fa fa-percent"></i>
                {{_("Redeem Discount Code")}}
                <hr style="margin:0;border-width: 2px; border-color: #5bc0de;">
            </h2>
            <div class="row">
                <div class="col-xs-6">
                    <div class="item form-group">
                        <label for="discount-code-entry">{{_("Enter Discount Code")}}</label>
                        <input type="hidden" name="discount_code_id" value="">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="" id="discount-code-entry">
                            <span class="input-group-btn">
                                <button class="btn btn-success" id="discount-code-entry-apply" type="button">{{_("Apply Discount")}}</button>
                            </span>
                        </div>
                        <span class="help-text" style="display: none;"><strong>{{_("Code applied !")}}</strong> {{_("10 percent off on monthly payments for 3 months")}}</span>
                    </div>
                </div>
            </div>

            <h2 style="font-weight:300; text-transform: uppercase; margin-top: 35px; color:#5bc0de;">
                <i class="fa fa-money"></i>
                {{_("Add Payment details")}}
                <hr style="margin:0;border-width: 2px; border-color: #5bc0de;">
            </h2>
            <div class="row">
                <div class="col-xs-6">
                    <div class="item form-group">
                        <label>{{_("Choose Country")}} <span class="required">*</span></label>
                        <select name="payment_country" id="payment_country_name" class="form-control">
                            {% if not event or not event.payment_country %}
                                <option value="">{{_("Choose a country for your payment")}}</option>
                            {% endif %}
                            {% for country in payment_countries %}
                                <option value="{{ country }}" {{ "selected" if event and event.payment_country == country else '' }}>{{ country }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-xs-6">
                    <div class="item form-group">
                        <label>{{_("Choose Currency")}} <span class="required">*</span></label>
                        <select name="payment_currency" id="payment_currency_name" class="form-control">
                            {% if not event or not event.payment_currency %}
                                <option value="">{{_("Please select a currency")}}</option>
                            {% endif %}
                            {% for code,has_paypal,has_stripe in payment_currencies %}
                                <option value="{{ code }}" data-has-paypal="{{ has_paypal }}" data-has-stripe="{{ has_stripe }}" {{ "selected" if event and event.payment_currency == code else '' }}>{{ code }} - {{ code | currency_name }} ({{ code | currency_symbol }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <div class="item form-group">
            <h2 style="font-weight:300; text-transform: uppercase; margin-top: 35px; color: #5bc0de;">
            <i class="fa fa-credit-card"></i>
            {{_("Choose Payment Methods")}}
            <hr style="margin:0;border-width: 2px; border-color: #5bc0de;">
            </h2>
            <div id="paypal-gateway">
                <label class="control-label" style="font-size: 20px;">{{_("Online Payments")}}</label>
                <div class="col-sm-12 input-group">
                        <label class="control-label">{{_("Payment by PayPal")}}</label>
                        <div class="checkbox">
                            <label style="font-weight: 300;">
                                <input type="checkbox" name="pay_by_paypal" id="pay_by_paypal"
                                       value="paypalYes"
                                       {% if event.pay_by_paypal %}checked="checked"{% endif %}>
                                <strong style="font-weight: 400;">{{_("YES, accept payment through PayPal ")}}</strong><br>
                                {{_("Paypal accepts credit card, debit card and PayPal payments. To learn how it works click")}} <a href="">{{_("here.")}}</a>
                            </label>
                        </div>
                </div>
                <div id="paypal-holder" class="item form-group" {% if not event.pay_by_paypal %}style="display: none"{% endif %}>
                    <label>PayPal Email <span class="required">*</span></label>
                    <input type="email" placeholder="PayPal Email" name="paypal_email" class="form-control"
                           value="{{ event.paypal_email | default('', true) }}">
                    <strong style="font-weight: 400;">{{_("Don't have a PayPal account?")}} </strong><a
                        href="https://www.paypal.com/us/webapps/mpp/referral/paypal-express-checkout?partner_id=W9QW5TKUA246E"
                        target="_blank">{{_("Create a free PayPal merchant account.")}}</a>
                </div>

            </div>
            <div id="stripe-gateway">
                <div class="col-sm-12 input-group">
                                        <label class="control-label">{{_("Payment by Stripe")}}</label>
                                        <div class="checkbox">
                                            <label style="font-weight: 300;">
                                                <input type="checkbox" name="pay_by_stripe" id="pay_by_stripe"
                                                       value="stripeYes"
                                                       {% if event.pay_by_stripe %}checked="checked"{% endif %}>
                                                <strong style="font-weight: 400;">{{_("YES, accept payment through Stripe")}} </strong><br>
                                                {{_("Stripe accepts Visa, Master and Amex. To learn how it works click")}} <a href="">{{_("here.")}}</a>
                                                {{_("Find out more about Stripe")}} <a href="">{{_("here.")}}</a>
                                            </label>
                                        </div>
                </div>
                <div id="stripe-holder" class="item form-group" {% if not event.pay_by_stripe %}style="display: none"{% endif %}>
                    <label>{{_("Use Stripe for payments")}} <span class="required">*</span></label><br>
                    <input type="hidden" name="stripe_added" value="{% if event.stripe %}yes{% else %}no{% endif %}">
                    <div id="stripe-connected-message" style="{% if not event.stripe %}display: none;{% endif %}">
                        <input type="hidden" name="stripe_secret_key" value="{{ event.stripe.stripe_secret_key | default('', true) }}">
                        <input type="hidden" name="stripe_refresh_token" value="{{ event.stripe.stripe_refresh_token | default('', true) }}">
                        <input type="hidden" name="stripe_publishable_key" value="{{ event.stripe.stripe_publishable_key | default('', true) }}">
                        <input type="hidden" name="stripe_user_id" value="{{ event.stripe.stripe_user_id | default('', true) }}">
                        <input type="hidden" name="stripe_email" value="{{ event.stripe.stripe_email | default('', true) }}">
                        {{_("The stripe account")}} <strong class="stripe-email">{{ event.stripe.stripe_email | default('', true) }}</strong> {{_("has been connected.")}} <a href="#" class="stripe-delink">{{_("Click to De-link the account.")}}</a><br><br>
                    </div>
                    <a href="#" class="stripe-connect" style="{% if event.stripe %}display:none;{% endif %}"><span>{{_("Connect with Stripe")}}</span></a>
                </div>
            </div>
            <br>
            <div id="offline-gateway">
            <label class="control-label" style="font-size: 20px;">{{_("Offline Payments")}}</label>
            <div class="col-sm-12 input-group">
                                    <div class="checkbox">
                                        <label style="font-weight: 300;">
                                            <input type="checkbox" name="pay_by_cheque" id="pay_by_cheque"
                                                   value="chequeYes"
                                                   {% if event.pay_by_cheque %}checked="checked"{% endif %}>
                                            <strong style="font-weight: 400;">{{_("YES, accept payment by Cheque")}} </strong><br>
                                        </label>
                                    </div>
                                    <div class="item form-group" id="cheque-instuctions-holder" {% if not event.pay_by_cheque %}style="display: none"{% endif %}>
                                        <label>{{_("Enter your PayPal account name and payment details instructions to ticket buyers")}} [See an
                                               <a href='#' data-toggle="modal" data-target="#chequeModal" title="Show cheque instructions"><strong style="font-weight: 400;">{{_("example")}}</strong></a> {{_("here")}}]
                                        </label>
                                        <textarea placeholder="Enter account details and instructions for cheque payment"
                                                name="cheque-details"
                                                class="form-control" rows="6" cols="15">{{ event.cheque_details | default('', true) }}</textarea>
                                    </div>

                                    <div class="checkbox">
                                        <label style="font-weight: 300;">
                                            <input type="checkbox" name="pay_by_bank" id="pay_by_bank"
                                                   value="bankYes"
                                                   {% if event.pay_by_bank %}checked="checked"{% endif %}>
                                            <strong style="font-weight: 400;">{{_("YES, accept payment by Telegraphic Transfer(TT) / Bank Transfer")}} </strong><br>
                                        </label>
                                    </div>
                                    <div class="item form-group" id="bank-instuctions-holder" {% if not event.pay_by_bank %}style="display: none"{% endif %}>
                                        <label>{{_("Enter your bank details and instructions to ticket buyers")}} [{{_("See an")}}
                                               <a href='#' data-toggle="modal" data-target="#bankModal" title="Show bank details instructions"><strong style="font-weight: 400;">{{_("example")}}</strong></a> {{_("here")}}]
                                        </label>
                                        <textarea placeholder="Enter account details and instructions for Telegraphic Transfer(TT) / Bank Transfer payment"
                                                name="bank-details"
                                                class="form-control" rows="6" cols="15">{{ event.bank_details | default('', true) }}</textarea>
                                    </div>

                                    <div class="checkbox">
                                        <label style="font-weight: 300;">
                                            <input type="checkbox" name="pay_onsite" id="pay_onsite"
                                                   value="onsiteYes"
                                                   {% if event.pay_onsite %}checked="checked"{% endif %}>
                                            <strong style="font-weight: 400;">{{_("YES, accept payment at the event(on site)")}} </strong><br>
                                        </label>
                                    </div>
                                    <div class="item form-group" id="onsite-instuctions-holder" {% if not event.pay_onsite %}style="display: none"{% endif %}>
                                        <label>{{_("Enter payment instructions to ticket buyers to make payments onsite")}}</label>
                                        <textarea placeholder="Enter instructions for payment at door"
                                                name="onsite-details"
                                                class="form-control" rows="6" cols="15">{{ event.onsite_details | default('', true) }}</textarea>
                                    </div>
            </div>
            </div>
            <br>
            <div class="">
                <a href='#' data-toggle="modal" data-target="#taxModal" title="Add tax option">
                    <h5>+ {{_("Add Tax")}}</h5>
                </a>
            </div>
        </div>
        </div>
        <h2 style="font-weight:300; text-transform: uppercase; margin-top: 35px; color: #5bc0de;">
            <i class="fa fa-plus-circle"></i>
            {{_("Additional Details")}}
            <hr style="margin:0;border-width: 2px; border-color: #5bc0de;">
        </h2>
        <div class="item form-group">
            <label class="control-label">{{_("Listing Privacy")}}</label>
            <div class="radio">
                <label style="font-weight: 300;">
                    <input type="radio" name="privacy" value="public"
                           {% if (event and event.privacy == 'public') or not event %}checked{% endif %}>
                    <strong style="font-weight: 400;">Public page:</strong> {{_("list this event on Open Event and search engines")}}
                </label>
            </div>
            <div class="radio">
                <label style="font-weight: 300;">
                    <input type="radio" name="privacy" value="private"
                           {% if (event and event.privacy == 'private') %}checked{% endif %}>
                    <strong style="font-weight: 400;">{{_("Private page")}}:</strong> {{_("do not list this event publicly")}}
                </label>
            </div>
        </div>

        <div class="item form-group">
            <label class="control-label">{{_("Event Type")}}</label>
            <select class="form-control" name="type">
                {% if not event or not event.type %}
                    <option value="">{{_("Choose")}}..</option>
                {% endif %}
                {% for type in event_types %}
                    <option value="{{ type }}" {{ "selected" if event and event.type == type else '' }}>{{ type }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="row">
            <div class="col-md-6 col-sm-6 col-xs-12">
                <div class="item form-group">
                    <label class="control-label">Event Topic
                    </label>
                    <select class="form-control" id="topic" name='topic'>
                        {% if not event or not event.topic %}
                            <option value="">{{_("Choose")}}..</option>
                        {% endif %}
                        {% for topic in event_topics %}
                            <option value="{{ topic }}" {{ "selected" if event and event.topic == topic else '' }}>{{ topic }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 col-sm-6 col-xs-12">
                <div class="item form-group">
                    <label class="control-label">{{_("Event Sub-Topic")}}
                    </label>
                    <select class="form-control" id="sub_topic" name='sub_topic'>
                        {% if not event or not event.sub_topic %}
                            <option value="">{{_("Choose")}}..</option>
                        {% endif %}
                        {% for sub_topic in event_sub_topics %}
                            <option value="{{ sub_topic }}" {{ "selected" if event and event.sub_topic == sub_topic else '' }}>{{ sub_topic }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        <div class="item form-group">
            <label><span class="coc-state">{{_("Add")}}</span> {{_("Code of Conduct")}}
            </label>
            <input type="checkbox" class="toggle-switch" name="coc_state"
                   value="on" id="coc-switch" {% if event.code_of_conduct %}checked="checked"{% endif %}/>
            <label for="coc-switch" style="margin-left:0;"></label>
            <div id="coc-holder" {% if not event.code_of_conduct %}style="display:none;"{% endif %}>
                <textarea name="code_of_conduct"
                          class="form-control event-textarea">{{ event.code_of_conduct | default('', true) }}</textarea>
            </div>
        </div>
        <div class="item form-group">
            <label>{{_("License of Event Data and Content")}} <a class="btn btn-info btn-xs licence-help"
                                                        data-toggle="licence-modal"
                                                        data-target="#licence_modal">?</a></label>
            <div id="licence-list" style="display: none;">
                <ul style="background-color: #f2f2f2; padding-left: 28px; padding-bottom: 5px; padding-top: 5px; border-radius: 1px;">
                    {% for licence_name, info in event_licences.iteritems() %}
                        <li>
                            <a href="{{ info.2 }}" target="_blank">{{ licence_name }}</a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            <select name="copyright_licence" class="form-control">
                <option value="">{{_("Choose Licence")}}</option>
                {{ event_licences }}
                {% for licence in event_licences %}
                    <option value="{{ licence }}" {{ "selected" if event and event.copyright.licence == licence else '' }}>
                        {{ licence }}
                    </option>
                {% endfor %}
            </select>
        </div>

    </div>
    <div class="col-md-1">
    </div>
    <div class="col-md-4">
    </div>
    <input type="hidden" name="latitude" id="latitude" value="{{ event.latitude | default(0.00, true) }}"/>
    <input type="hidden" name="longitude" id="longitude" value="{{ event.longitude | default(0.00, true) }}"/>

</div>

<div class="modal fade" tabindex="-1" role="dialog" id="cropper-modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">{{_("Crop your image")}}</h4>
            </div>
            <div class="modal-body">
                <div id="upload-cropper">

                </div>
            </div>
            <div class="modal-footer">
                <div class="btn-group">
                    <button type="button" class="btn btn-default" data-dismiss="modal">{{_("Cancel")}}</button>
                    <button type="button" id="save-crop" class="btn btn-success">{{_("Done")}}</button>
                </div>

            </div>
        </div>
    </div>
</div>

<form role="form" id="tax-form" action="/events/tax/include/" method="post">
    <div class="modal fade" id="taxModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span>
                    </button>
                    <h3 class="modal-title">{{_("Tax Options")}}</h3>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-sm-12">
                            <div id="tax-charge-holder">
                                <h3>{{_("Do you need to charge tax for this event ?")}} <a href="#" data-toggle="tooltip" title="Some event organizers need to charge tax on their tickets.
                                                            Please check with your tax advisor about your own situation"
                                                                                  class="fa fa-info-circle"></a></h3>
                                <div class="radio">
                                    <label style="font-weight: 300;">
                                        <input type="radio" name="taxAllow" id="taxYes" value="taxYes"
                                               {% if event.tax_allow %}checked="checked"{% endif %}>
                                        <h5>Yes</h5>
                                    </label>
                                </div>
                                <div class="radio">
                                    <label style="font-weight: 300;">
                                        <input type="radio" name="taxAllow" id="taxNo" value="taxNo"
                                               {% if not event.tax_allow %}checked="checked"{% endif %}>
                                        <h5>No</h5>
                                    </label>
                                </div>
                            </div>
                            <div id="tax-form-holder" {% if not event.tax_allow %}style="display: none";{% endif %}>
                                <div class="col-sm-12 input-group">
                                    <label>{{_("Country")}}<span class="required">*</span></label>
                                    <select name="tax_country" id="tax_country_name" class="form-control">
                                        {% if not event or not tax.country %}
                                            <option value="">{{_("Choose a country for your tax payment")}}</option>
                                        {% endif %}
                                        {% for country in payment_countries %}
                                            <option value="{{ tax.country | default('', true) }}" {{ "selected" if event and tax.country == country else '' }}>{{ country }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="col-sm-12 input-group">
                                    <label for="tax_name">{{_("Tax Name")}}<span class="required">*</span></label>
                                    <input type="text" id="tax_name" name="tax_name" class="form-control"
                                           value="{{ tax.tax_name | default('', true) }}">
                                </div>

                                <div class="col-sm-12 input-group">
                                    <label for="tax_rate">{{_("Tax Rate")}}<span class="required">*</span></label>
                                    <input value="{{ tax.tax_rate | default(0, true) }}" type="text"
                                           class="form-control" name="tax_rate" id="tax_rate"
                                           placeholder="Enter Tax Rate">
                                </div>

                                <div class="col-sm-12 input-group">
                                    <label for="tax_id">{{_("Tax ID")}}<span class="required">*</span></label>
                                    <input value="{{ tax.tax_id | default(0, true) }}" type="text" class="form-control"
                                           name="tax_id" id="tax_id"
                                           placeholder="Enter Tax ID">
                                </div>

                                <div class="col-sm-12 input-group">
                                    <label class="control-label">{{_("Tax Invoices")}}:</label>
                                    <div class="checkbox">
                                        <label style="font-weight: 300;">
                                            <input type="checkbox" name="tax_invoice" id="tax_invoice"
                                                   value="invoiceYes"
                                                   {% if tax.send_invoice %}checked="checked"{% endif %}>
                                            <strong style="font-weight: 400;">{{_("Send tax invoice to attendees")}}: </strong>
                                            {{_("Tax Invoices are sent to your attendees when you select this feature.")}}
                                            {{_("Enter your registered business company name and address to be included on the tax invoice")}}
                                        </label>
                                    </div>
                                </div>
                                <div id="tax-invoice-holder"
                                     {% if not tax.send_invoice %}style="display: none"{% endif %}>
                                    <div class="col-sm-12 input-group">
                                        <label for="registered_company">{{_("Registered Company")}}<span
                                                class="required">*</span></label>
                                        <input value="{{ tax.registered_company | default('', true) }}" type="text"
                                               class="form-control" name="registered_company" id="registered_company"
                                               placeholder="Enter Company Name">
                                    </div>

                                    <div class="col-sm-12 input-group">
                                        <label for="buisness_address">{{_("Business Address")}}<span
                                                class="required">*</span></label>
                                        <input value="{{ tax.address | default('', true) }}" type="text"
                                               class="form-control" name="buisness_address" id="buisness_address"
                                               placeholder="Enter Business Address">
                                    </div>

                                    <div class="col-sm-12 input-group">
                                        <label for="invoice_city">{{_("City")}}<span class="required">*</span></label>
                                        <input value="{{ tax.city | default('', true) }}" type="text"
                                               class="form-control" name="invoice_city" id="invoice_city"
                                               placeholder="City">
                                    </div>

                                    <div class="col-sm-12 input-group">
                                        <label for="invoice_state">{{_("State")}}<span class="required">*</span></label>
                                        <input value="{{ tax.state | default('', true) }}" type="text"
                                               class="form-control" name="invoice_state" id="invoice_state"
                                               placeholder="State">
                                    </div>

                                    <div class="col-sm-12 input-group">
                                        <label for="invoice_zip">Zip<span class="required">*</span></label>
                                        <input value="{{ tax.zip | default(0, true) }}" type="text" class="form-control"
                                               name="invoice_zip" id="invoice_zip"
                                               placeholder="Zip">
                                    </div>

                                    <div class="col-sm-12 input-group">
                                        <label for="invoice_footer">{{_("Optional Text for Invoice Footer")}}<span
                                                class="required">*</span></label>
                                        <textarea class="form-control" name="invoice_footer"
                                                  id="invoice_footer">{{ tax.invoice_footer | default('', true) }}" </textarea>
                                    </div>
                                </div>

                                <div class="col-sm-12 input-group">
                                    <label class="control-label">{{_("Add or Include")}}:</label>
                                    <div class="radio">
                                        <label style="font-weight: 300;">
                                            <input type="radio" name="tax_options" value="tax_separate"
                                                   {% if not tax.tax_include_in_price %}checked="checked"{% endif %}>
                                            <strong style="font-weight: 400;">{{_("Add tax as separate fee on top of the price")}}</strong>
                                        </label>
                                    </div>
                                    <div class="radio">
                                        <label style="font-weight: 300;">
                                            <input type="radio" name="tax_options" value="tax_include"
                                                   {% if tax.tax_include_in_price %}checked="checked"{% endif %}>
                                            <strong style="font-weight: 400;">{{_("Include tax in ticket price")}}</strong>
                                        </label>
                                    </div>
                                </div>

                            </div>

                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="reset" id="close-tax-form" class="btn btn-default" data-dismiss="modal">
                        {{_("Save")}}
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

<form role="form" id="cheque-form" method="post">
    <div class="modal fade" id="chequeModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span>
                    </button>
                    <h3 class="modal-title">{{_("Cheque Instructions")}}</h3>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-sm-12">
                            <div>
                                <textarea class="form-control" rows="20">To be made in Singapore Dollars, payable to the A/C:&#13;&#10;Payee Name: ABC Pvt. Ltd&#13;&#10;&#13;&#10;Please mail the check to:&#13;Mailing Address:&#13;&#10;ABC Pvt Ltd&#13;&#10;71 Ayer Rajah Crescent #01-23&#13;&#10;Singapore 123456&#13;&#10;&#13;&#10;Note:&#13;&#10;1. The cheque should be crossed by drawing two parallel lines across the top
left-hand corner of the cheque.&#13;&#10;2. Indicate the order ref. no. and company's name at the back of the cheque.
                                </textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="reset" id="close-cheque-form" class="btn btn-default" data-dismiss="modal">
                        {{_("Save")}}
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

<form role="form" id="bank-form" method="post">
    <div class="modal fade" id="bankModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span>
                    </button>
                    <h3 class="modal-title">{{_("Bank Instructions")}}</h3>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-sm-12">
                            <div>
                                <textarea class="form-control" rows="20">Please make the full payment to the following account:&#13;&#10;&#13;&#10;Once you made the payment , kindly drop an email to enquiry@abc.com to inform your
payment and indicate your order ref. no.&#13;&#10;&#13;&#10;Account Details&#13;==================&#13;&#10;Account Name: ABC Pvt Ltd&#13;&#10;Account Number: 591-497xxxx-xxxx(Current Account)&#13;&#10;Bank Name&#13;&#10;&#13;&#10;If you need further info:&#13;&#10;Bank Code: 1234&#13;&#10;Branch Code:123&#13;&#10;Bank Address: Some address&#13;&#10;Swift Code: OBCSDGCGC
                                </textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="reset" id="close-bank-form" class="btn btn-default" data-dismiss="modal">
                        {{_("Save")}}
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
    var marker, map;
    var init_marker;
    var placeSearch, autocomplete;
    var paid_tickets = 0;
    var componentForm = {
        street_number: 'short_name',
        route: 'long_name',
        locality: 'long_name',
        administrative_area_level_1: 'short_name',
        country: 'long_name',
        postal_code: 'short_name'
    };
    var $latitudeInput = $('#latitude');
    var $longitudeInput = $('#longitude');
    var $locationInput = $("#location_name");
    function initPlacesApi() {
        var latitude = $latitudeInput.val();
        var longitude = $longitudeInput.val();
        var latlng = new google.maps.LatLng(latitude, longitude);
        map = new google.maps.Map($("#map")[0], {
            zoom: 1,
            center: latlng
        });

        var geocoder = new google.maps.Geocoder();
        init_marker = new google.maps.Marker({
            draggable: true,
            position: latlng,
            map: map,
            zoom: 15
        });

        var geocodeHandler = function () {
            $locationInput.closest(".form-group").removeClass("has-warning");
            geocodeAddress(geocoder, map);
        };

        $locationInput.valueChange(geocodeHandler);

        autocomplete = new google.maps.places.Autocomplete($locationInput[0], {types: ['geocode']});
        geolocate();

        autocomplete.addListener('place_changed', geocodeHandler);

    }
    function fillInAddress(map) {
        // Get the place details from the autocomplete object.
        var place = autocomplete.getPlace();
        // Get each component of the address from the place details
        // and fill the corresponding field on the form.

        for (var i = 0; i < place.address_components.length; i++) {
            var addressType = place.address_components[i].types[0];
            if (componentForm[addressType]) {
                console.log(addressType);
                var val = place.address_components[i][componentForm[addressType]];
                document.getElementById(addressType).value = val;
            }
        }
        $('#location_name').hide();
        $('#show_addr').hide();
        $('#map-holder').show();
        resizeMap(map);
    }

    function resizeMap(map) {
        var center = map.getCenter();
        google.maps.event.trigger(map, 'resize');
        map.setZoom(map.getZoom());
        map.setCenter(center);
    }

    function geocodeAddress(geocoder, resultsMap) {
        var address = $locationInput.val();
        geocoder.geocode({'address': address}, function (results, status) {
            if (status === google.maps.GeocoderStatus.OK) {
                $latitudeInput.val(results[0].geometry.location.lat());
                $longitudeInput.val(results[0].geometry.location.lng());
                resultsMap.setCenter(results[0].geometry.location);
                resultsMap.setZoom(10);
                init_marker.setMap(null);
                if (marker == null) {
                    marker = new google.maps.Marker({
                        map: resultsMap,
                        draggable: true,
                        position: results[0].geometry.location
                    });
                }
                else {
                    marker.setMap(null);
                    marker = new google.maps.Marker({
                        map: resultsMap,
                        draggable: true,
                        position: results[0].geometry.location
                    });
                }
                fillInAddress(resultsMap);
            } else {
                if (status === 'ZERO_RESULTS') {
                    resultsMap.setZoom(1);
                    $latitudeInput.val(0.0);
                    $longitudeInput.val(0.0);
                }
                console.log('Geocode was not successful for the following reason: ' + status);
            }
        });
    }

    function geolocate() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                var geolocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                var circle = new google.maps.Circle({
                    center: geolocation,
                    radius: position.coords.accuracy
                });
                autocomplete.setBounds(circle.getBounds());
            });
        }
    }

    function show_map_holder() {
        if ($('#location_name').get(0).value != '') {
            var url = "https://maps.googleapis.com/maps/api/geocode/json?address=" + $('#location_name').get(0).value + "&key=AIzaSyAHdXg0Y_zk-wCNpslbBqcezLdHniaEwkI"
            $.getJSON(url, function (data) {
                google.maps.event.trigger(autocomplete, 'place_changed');
                var place = data.results[0];
                for (var i = 0; i < place.address_components.length; i++) {
                    var addressType = place.address_components[i].types[0];
                    if (componentForm[addressType]) {
                        console.log(addressType);
                        var val = place.address_components[i][componentForm[addressType]];
                        document.getElementById(addressType).value = val;
                    }
                }
            });
        }
        $('#location_name').hide();
        $('#map-holder').show();
        $('#show_addr').hide();
        resizeMap(map);
    }

    function remove_map_holder() {
        for (var component in componentForm) {
            document.getElementById(component).value = '';
        }
        autocomplete.set('place', void(0));
        $('#location_name').get(0).value = '';
        $('#location_name').show();
        $('#map-holder').hide();
        $('#show_addr').show();
    }

    function address_update() {
        autocomplete.set('place', void(0));
        var location = "";
        for (component in componentForm) {
            location += $('#' + component).get(0).value + " ";
        }
        $('#location_name').get(0).value = location;
        $('#location_name').click();
    }

    var $uploadCropper = $('#upload-cropper');
    $(document).ready(function () {

        $('.time').timepicker({
            'showDuration': true,
            'timeFormat': 'H:i',
            'scrollDefault': 'now'
        });

        $('.date').datepicker({
            'format': 'mm/dd/yyyy',
            'autoclose': true
        });

        $(".event-date-picker").datepair({
            'defaultTimeDelta': 3600000
        });

        $("textarea.event-textarea").summernote(summernoteConfig);

        $('select[name=timezone]').selectize({
            create: false,
            sortField: 'text'
        });

        $(".licence-help").click(function () {
            $("#licence-list").slideToggle();
        });

        var sub_topics = {{event_sub_topics|safe}};

        var $topic = $("#topic");
        var $subTopic = $('#sub_topic');
        $topic.change(function () {
            $subTopic.find('option').remove().end().append('<option value="">Choose..</option>');
            $.each(sub_topics[$(this).val()], function () {
                $subTopic.append($("<option />").val(this).text(this));
            });
        });

        if ($topic.val() !== "") {
            $subTopic.find('option').remove().end().append('<option value="">Choose..</option>');

            $.each(sub_topics[$topic.val()], function () {
                $subTopic.append($("<option />").val(this).text(this));
            });
            $subTopic.val("{{event.sub_topic}}");
        }


        $uploadCropper = $('#upload-cropper').croppie({
            viewport: {
                width: 490,
                height: 245,
                type: 'square'
            },
            boundary: {
                width: 508,
                height: 350
            }
        });

        $("#event-image-upload").unbind("change").on('change', function () {
            var input = this;
            if (input.files && input.files[0]) {
                if (input.files[0].size > 10485760) {
                    createSnackbar("Image must be less than 10 MB in size");
                    resetFormElement(input);
                } else {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        $("#cropper-modal").modal("show");
                        $uploadCropper.croppie('bind', {
                            url: e.target.result
                        });
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            }
            else {
                logError("No FileReader support");
            }

        });

        $("#logo-upload").unbind("change").on('change', function () {
            var input = this;
            if (input.files && input.files[0]) {
                if (input.files[0].size > 1048576) {
                    createSnackbar("Image must be less than 1 MB in size");
                    resetFormElement(input);
                } else {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        $("#logo-upload-label").html(loadingImage);
                        /* Disable Save Event buttons */
                        $(".save-event").prop("disabled", true);
                        $(".publish-unpublish-event").prop("disabled", true);
                        $.ajax({
                            type: 'POST',
                            url: "{{ url_for('events.logo_upload', event_id=event.id) if event else url_for('events.create_event_logo_upload') }}",
                            data: {logo: e.target.result},
                            dataType: 'json'
                        }).done(function(data) {
                            console.log(data);
                            resetFormElement(input);
                            $("#logo").val(data.logo);
                            $("#logo-upload-group").hide();
                            $("#logo-view-group").show().find("img").attr("src", e.target.result);
                        }).fail(function(data) {
                            alert("Something went wrong. Please try again.");
                        }).always(function() {
                            $("#logo-upload-label").html('<i class="fa fa-4x fa-file-image-o" aria-hidden="true"></i> <br> <h3>Select Logo</h3>');
                            /* Enable Save Event buttons */
                            $(".save-event").prop("disabled", false);
                            $(".publish-unpublish-event").prop("disabled", false);
                        });
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            }
            else {
                logError("No FileReader support");
            }

        });
    });

    var loadingImage = '<img src="' + "{{ url_for('static', filename='img/loading.gif') }}" + '" style="width: 50px;"> <h3>Uploading</h3>';
    $("#save-crop").click(function () {
        $uploadCropper.croppie('result', {
            type: 'canvas',
            size: 'original'
        }).then(function (resp) {
            $('#cropper-modal').modal('hide')
            $("#event-image-upload-label").html(loadingImage);
            /* Disable Save Event buttons */
            $(".save-event").prop("disabled", true);
            $(".publish-unpublish-event").prop("disabled", true);
            $.ajax({
                type: 'POST',
                url: "{{ url_for('events.bgimage_upload', event_id=event.id) if event else url_for('events.create_event_bgimage_upload') }}",
                data: {bgimage: resp},
                dataType: 'json'
            }).done(function(data) {
                console.log(data);
                $("#background_url").val(data.background_url);
                $("#image-view-group").show().find("img").attr("src", resp);
                $("#image-upload-group").hide();
            }).fail(function(data) {
                alert("Something went wrong. Please try again.");
            }).always(function() {
                $("#event-image-upload-label").html('<i class="fa fa-4x fa-camera-retro" aria-hidden="true"></i><br><h3>Select Event Image</h3>');
                /* Enable Save Event buttons */
                $(".save-event").prop("disabled", false);
                $(".publish-unpublish-event").prop("disabled", false);
            });
        });
    });

    {% if event %}
    $("#remove-image-btn").click(function () {
        $.ajax({
            type: 'DELETE',
            url: "{{ url_for('events.bgimage_upload', event_id=event.id) }}",
            dataType: 'json'
        }).done(function(data) {
            console.log(data);
            $("#image-view-group").hide();
            $("#image-upload-group").show();
            $("#background_url").val('');
        }).fail(function(data) {
            alert("Something went wrong. Please try again.");
        });
    });

    $("#remove-logo-btn").click(function () {
        $.ajax({
            type: 'DELETE',
            url: "{{ url_for('events.logo_upload', event_id=event.id) }}",
            dataType: 'json'
        }).done(function(data) {
            console.log(data);
            $("#logo-view-group").hide();
            $("#logo-upload-group").show();
            $("#logo").val('');
        }).fail(function(data) {
            alert("Something went wrong. Please try again.");
        });
    });
    {% else %}
    $("#remove-image-btn").click(function () {
        $("#image-view-group").hide();
        $("#image-upload-group").show();
        $("#background_url").val('');
    });

    $("#remove-logo-btn").click(function () {
        $("#logo-view-group").hide();
        $("#logo-upload-group").show();
        $("#logo").val('');
    });
    {% endif %}

    $('#cropper-modal').on('shown.bs.modal', function (e) {
        $uploadCropper.croppie('bind');
        resetFormElement($("#event-image-upload"));

    });

    $("select#ticket-type").on("change", function (e) {
        var type = $("option:selected", this).val();
        var ticketTypePrice = $("#ticket-type-price");

        if (type == "free") {
            ticketTypePrice.html("<div class='form-control'>Free</div>");
        } else if (type == "donation") {
            ticketTypePrice.html("<div class='form-control'>Donation</div>");
        } else if (type == "paid") {
            ticketTypePrice.html("<input type='number' class='form-control' placeholder='Set your ticket price' name='ticket_price' required>");
        }
    });

    var $ticketsHolder = $(".tickets-holder");
    var ticketsCount = 1;
    var $paymentsystemHolder = $("#payment-system-holder");

    $(document).ready(function() {
        $("#event-wizard-form .ticket-tags").selectize({
            plugins: ['remove_button'],
            persist: false,
            createOnBlur: true,
            create: true
        });
    });

    function addTicket(type) {
        /* Clone ticket from template */
        var $tmpl = $("#ticket-template").clone().children("div");
        var $ticket = $($tmpl[0]).attr("id", "ticket_" + String(ticketsCount));
        var $ticketMore = $($tmpl[1]).attr("id", "ticket-more_" + String(ticketsCount));

        /* Bind datepicker to dates */
        $ticketMore.find("input.date").datepicker();
        $ticketMore.find("input.time").timepicker({
            'showDuration': true,
            'timeFormat': 'H:i',
            'scrollDefault': 'now'
        });

        /* iCheck for Ticket description toggle checkbox */
        $ticketMore.find("input.checkbox.flat").iCheck({
            checkboxClass: 'icheckbox_flat-green',
            radioClass: 'iradio_flat-green'
        });

        $ticketMore.find(".ticket-tags").selectize({
            plugins: ['remove_button'],
            persist: false,
            createOnBlur: true,
            create: true
        });

        /* Bind events to Edit and Remove buttons */
        var $ticketEdit = $ticket.find(".edit-ticket-button");
        $ticketEdit.tooltip();
        $ticketEdit.on("click", function () {
            $ticketMore.slideToggle("slow");
        });
        var $ticketRemove = $ticket.find(".remove-ticket-button");
        $ticketRemove.tooltip();
        $ticketRemove.on("click", function () {
            var confirmRemove = confirm("Are you sure you want to remove the Ticket?");
            if (confirmRemove) {
                if (type == 'paid' || type == 'donation') {
                    paid_tickets = paid_tickets - 1;
                    if (paid_tickets == 0) {
                        $paymentsystemHolder.fadeOut();
                    }
                }
                $ticket.remove();
                $ticketMore.remove();
            }
        });

        /* Set Ticket Type field */
        $ticket.find("input[name='tickets[type]']").val(type);

        /* Set Ticket Price field */
        var html = null;
        if (type === "free") {
            html = '<input type="text" name="tickets[price]" class="form-control" value="Free" readonly>';
        } else if (type === "paid") {
            html = '<input type="number" min="0" name="tickets[price]" class="form-control"  placeholder="Price" value="">';
        } else if (type === "donation") {
            html = '<input type="text" name="tickets[price]" class="form-control" value="Donation" readonly>';
        }
        $($ticket.children()[1]).html(html);

        /* Append ticket to table */
        $ticket.hide();
        $ticketMore.hide();
        $ticketsHolder.append($ticket, $ticketMore);
        $ticket.slideToggle();

        /* Set name attribute for all Ticket Description Toggle checkboxes */
        $("#event-wizard-form input[name*='tickets_description_toggle_']").each(function(i, el) {
            $(el).attr("name", "tickets_description_toggle_" + String(i));
        });
        /* Set name attribute for all Ticket Stop Sales checkboxes */
        $("#event-wizard-form input[name*='tickets_hide_']").each(function(i, el) {
            $(el).attr("name", "tickets_hide_" + String(i));
        });

        ticketsCount += 1;
    }

    $(".edit-ticket-button").click(function () {
        var $ticket = $(this).parent().parent().parent();
        var $ticketMore = $ticket.next();
        $ticketMore.slideToggle("slow");
    });

    $(".remove-ticket-button").click(function () {
        var confirmRemove = confirm("Are you sure you want to remove the Ticket?");
        if (confirmRemove) {
            var $ticket = $(this).parent().parent().parent();
            var $ticketMore = $ticket.next();
            $ticket.remove();
            $ticketMore.remove();
        }
    });

    $(".add-free-ticket").click(function () {
        addTicket("free");
    });

    $(".add-paid-ticket").click(function () {
        if (paid_tickets == 0) {
            $paymentsystemHolder.fadeIn();
        }
        paid_tickets += 1;
        addTicket("paid");
    });

    $(".add-donation-ticket").click(function () {
        if (paid_tickets == 0) {
            $paymentsystemHolder.fadeIn();
        }
        paid_tickets += 1;
        addTicket("donation");
    });

    var $taxformHolder = $("#tax-form-holder");
    $("#taxYes").on("click", function (e) {
        $taxformHolder.fadeIn();
    });
    $("#taxNo").on("click", function (e) {
        $taxformHolder.fadeOut();
    });

    var $taxinvoiceHolder = $("#tax-invoice-holder");
    $("#tax_invoice").change(function () {
        if ($("#tax_invoice").is(":checked"))
            $taxinvoiceHolder.fadeIn();
        else
            $taxinvoiceHolder.fadeOut();
    });

    $(document).on("click", '.add-social-links', function () {
        var $element = $($(".social-link-holder")[0]).clone();
        $element.find("input").val('').attr("value", "");
        $('.social-links > div').append($element);
    });

    $(document).on("click", ".remove-social-links", function () {
        if ($('.social-links > div').children().length > 1) {
            $(this).closest(".social-link-holder").remove();
        }
    });

    function resetFormElement(e) {
        e = $(e);
        e.wrap('<form>').closest('form').get(0).reset();
        e.unwrap();
    }

    $(function () {
        var $cocHolder = $("#coc-holder");
        var $cocState = $(".coc-state");

        var coc_onOffSwitch = document.getElementById('coc-switch');

        coc_onOffSwitch.onchange = function () {
            if (coc_onOffSwitch.checked) {
                $cocHolder.fadeIn();
                $cocState.text("Remove");
            } else {
                $cocHolder.fadeOut();
                $cocState.text("Add");
            }
        };

        var $organizerHolder = $("#organizer-holder");
        var $organizerState = $(".organizer-state");

        var organizer_onOffSwitch = document.getElementById('organizer-switch');

        organizer_onOffSwitch.onchange = function () {
            if (organizer_onOffSwitch.checked) {
                $organizerHolder.fadeIn();
                $organizerState.text("Remove");
            } else {
                $organizerHolder.fadeOut();
                $organizerState.text("Add");
            }
        };

        var $ticketsystemHolder = $("#ticket-system-holder");
        var $ticketURLHolder = $("#ticket-url-holder")
        var $ticketState = $(".ticket-state");

        var ticket_onOffSwitch = document.getElementById('ticket-switch');

        if (ticket_onOffSwitch != null) {
            ticket_onOffSwitch.onchange = function () {
                if (ticket_onOffSwitch.checked) {
                    $ticketsystemHolder.fadeIn();
                    $ticketURLHolder.fadeOut();
                    $ticketState.text("Add Ticket URL");
                } else {
                    $ticketsystemHolder.fadeOut();
                    $ticketURLHolder.fadeIn();
                    $ticketState.text("Use Ticketing System");
                }
            };
        }
        var $stripeConnectedMessage = $("#stripe-connected-message");
        $(".stripe-connect").click(function (e) {
            e.preventDefault();
            $.oauthpopup({
                path: "https://connect.stripe.com/oauth/authorize?response_type=code&client_id={{ key_settings.stripe_client_id }}&scope=read_write&redirect_uri={{ url_for('ticketing.stripe_callback', _external=true) }}",
                callback: function () {
                    // TODO Disallow test accounts. Only accept live accounts.
                    if (1 || window.oauth_response.live_mode) {
                        $("input[name=stripe_added]").val("yes");
                        $stripeConnectedMessage.find("input[name=stripe_secret_key]").val(window.oauth_response.access_token);
                        $stripeConnectedMessage.find("input[name=stripe_refresh_token]").val(window.oauth_response.refresh_token);
                        $stripeConnectedMessage.find("input[name=stripe_publishable_key]").val(window.oauth_response.stripe_publishable_key);
                        $stripeConnectedMessage.find("input[name=stripe_user_id]").val(window.oauth_response.stripe_user_id);
                        $stripeConnectedMessage.find("input[name=stripe_email]").val(window.oauth_response.email);
                        $stripeConnectedMessage.find(".stripe-email").text(window.oauth_response.email);
                        $stripeConnectedMessage.show();
                        $(".stripe-connect").hide();
                    } else {
                        createSnackbar('Your stripe account is not live. Only live accounts can be used for collecting payments.')
                    }
                }
            });

        });

        $(".stripe-delink").click(function (e) {
            e.preventDefault();
            $("input[name=stripe_added]").val("no");
            $stripeConnectedMessage.hide();
            $stripeConnectedMessage.find("input").val("");
            $stripeConnectedMessage.find(".stripe-email").text("");
            $(".stripe-connect").show();
        });

        var $paypalHolder = $("#paypal-holder");
        $("#pay_by_paypal").change(function () {
            if ($("#pay_by_paypal").is(":checked"))
                $paypalHolder.fadeIn();
            else
                $paypalHolder.fadeOut();
        });

        var $stripeHolder = $("#stripe-holder");
        $("#pay_by_stripe").change(function () {
            if ($("#pay_by_stripe").is(":checked"))
                $stripeHolder.fadeIn();
            else
                $stripeHolder.fadeOut();
        });

        $("select[name=payment_currency]").change(function () {
            var $selected = $(this).find(":selected");
            if($selected.data("has-paypal") !== "True") {
                $("#paypal-gateway").fadeOut().find("input").prop("checked", false).val("");
            } else {
                $("#paypal-gateway").fadeIn();
            }
            if($selected.data("has-stripe") !== "True") {
                $("#stripe-gateway").fadeOut().find("input").prop("checked", false).val("");
            } else {
                $("#stripe-gateway").fadeIn();
            }
        }).trigger('change');

        var $chequeHolder = $("#cheque-instuctions-holder");
        $("#pay_by_cheque").change(function () {
            if ($("#pay_by_cheque").is(":checked"))
                $chequeHolder.fadeIn();
            else
                $chequeHolder.fadeOut();
        });

        var $bankHolder = $("#bank-instuctions-holder");
        $("#pay_by_bank").change(function () {
            if ($("#pay_by_bank").is(":checked"))
                $bankHolder.fadeIn();
            else
                $bankHolder.fadeOut();
        });

        var $onsiteHolder = $("#onsite-instuctions-holder");
        $("#pay_onsite").change(function () {
            if ($("#pay_onsite").is(":checked"))
                $onsiteHolder.fadeIn();
            else
                $onsiteHolder.fadeOut();
        });

        var $discountCodeEntry = $("#discount-code-entry");
        var $discountCodeFormGroup = $discountCodeEntry.closest('.form-group');
        var $discountCodeId = $discountCodeFormGroup.find('input[name=discount_code_id]');
        var $helpText = $discountCodeFormGroup.find('.help-text');
        var $discountCodeEntryApply = $("#discount-code-entry-apply");

        var discountCodeApplyUrl = "{{ url_for('events.apply_discount_code')  }}";

        $discountCodeEntryApply.click(function () {
            $discountCodeFormGroup.removeClass('has-error').removeClass('has-success');
            $helpText.removeClass('text-danger').removeClass('text-success').hide();
            $discountCodeId.val("");
            var discountCodeValue = $discountCodeEntry.val().trim();
            if(discountCodeValue != "") {
                $discountCodeEntry.disable();
                $discountCodeEntryApply.html('Verifying <i class="fa fa-spin fa-cog fa-fw"></i>').disable();
                $.post(discountCodeApplyUrl, { discount_code: discountCodeValue })
                  .done(function(data) {
                      $discountCodeEntry.enable();
                      $discountCodeEntryApply.enable().html('Apply Discount');
                      $helpText.show();
                      if(data.status === 'ok') {
                          $discountCodeFormGroup.addClass('has-success');
                          $discountCodeId.val(data.discount_code.id);
                          var message = data.discount_code.value + "% over a period of " + data.discount_code.max_quantity + " month(s)";
                          $helpText.addClass('text-success').html("<strong>Discount Applied!</strong> " + message);
                      } else {
                          $discountCodeFormGroup.addClass('has-error');
                          if(data.hasOwnProperty('message')) {
                              $helpText.addClass('text-danger').text(data.message);
                          } else {
                              $helpText.addClass('text-danger').text("An error occurred while trying to apply the discount code.");
                          }
                      }
                  });

            }
        });

        $discountCodeEntry.valueChange(function (value) {
            $discountCodeFormGroup.removeClass('has-error').removeClass('has-success');
            $helpText.removeClass('text-danger').removeClass('text-success').hide();
            $discountCodeEntryApply.enable().html('Apply Discount');
            $discountCodeId.val("");
        });
    });
</script>

